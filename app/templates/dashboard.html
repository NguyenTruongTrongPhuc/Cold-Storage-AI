{% extends "base.html" %}

{% block title %}Dashboard Tổng quan{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center">
    <h1 class="h2 mb-4">Dashboard Tổng quan</h1>
    <span class="badge bg-success-subtle text-success-emphasis rounded-pill">● Live</span>
</div>

<div id="ai-agent-widget-container" class="mb-4">
    </div>

<div class="row">
    <div class="col-xl-8 mb-4">
        <div class="card bg-dark-subtle border-secondary h-100">
            <div class="card-body">
                <h5 class="card-title">Sơ đồ nhiệt Kho lạnh</h5>
                <div id="heatmap-container" class="d-flex flex-column mt-3"></div>
            </div>
        </div>
    </div>
    <div class="col-xl-4 mb-4">
        <div class="row">
            <div class="col-12 mb-4">
                <div class="card bg-dark-subtle border-secondary">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Nhiệt độ Trung bình</h6>
                        <p class="display-4 fw-light" id="avg_temp">-20.1<span class="fs-5 text-muted">°C</span></p>
                    </div>
                </div>
            </div>
            <div class="col-12 mb-4">
                <div class="card bg-dark-subtle border-secondary">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Độ ẩm</h6>
                        <p class="display-4 fw-light" id="humidity">88.0<span class="fs-5 text-muted">%</span></p>
                    </div>
                </div>
            </div>
            <div class="col-12">
                 <div class="card bg-dark-subtle border-secondary">
                    <div class="card-header">Trạng thái Thiết bị</div>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item bg-dark-subtle d-flex justify-content-between align-items-center">Máy nén <span class="badge" id="compressor_status"></span></li>
                        <li class="list-group-item bg-dark-subtle d-flex justify-content-between align-items-center">Công suất<span id="compressor_power_kw" class="fw-bold">0 kW</span></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-7 mb-4">
        <div class="card bg-dark-subtle border-secondary h-100">
            <div class="card-body">
                <h5 class="card-title">Dự báo Tải nhiệt (kW)</h5>
                <div id="forecast-chart"></div>
            </div>
        </div>
    </div>
    <div class="col-lg-5 mb-4">
        <div class="card bg-dark-subtle border-secondary h-100">
            <div class="card-body">
                <h5 class="card-title">Lịch trình Tối ưu Máy nén (24h)</h5>
                <div id="schedule-chart"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // --- KHU VỰC CODE CỦA AI AGENT ---
    const aiWidgetContainer = document.getElementById('ai-agent-widget-container');

    async function fetchAiRecommendations() {
        try {
            const response = await fetch('/api/ai-agent/recommendations');
            const recommendations = await response.json();
            
            if (recommendations.length > 0 && aiWidgetContainer.innerHTML.trim() === '') {
                renderRecommendationCard(recommendations[0]);
            } else if (recommendations.length === 0) {
                aiWidgetContainer.innerHTML = '';
            }
        } catch (error) {
            console.error("Lỗi khi lấy khuyến nghị từ AI Agent:", error);
        }
    }

    function renderRecommendationCard(rec) {
        const cardHTML = `
            <div class="card border-info bg-info-subtle text-info-emphasis" id="rec-${rec.id}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-robot me-2"></i> ${rec.title}</h5>
                    <small>Đề xuất từ AI Agent</small>
                </div>
                <div class="card-body">
                    <p class="card-text"><strong>Lý do:</strong> ${rec.reason}</p>
                    <p class="fw-bold"><strong>Hành động đề xuất:</strong> ${rec.action_suggestion}</p>
                </div>
                <div class="card-footer text-end bg-transparent border-info">
                    <button class="btn btn-sm btn-outline-secondary" onclick="dismissRecommendation('${rec.id}')">Bỏ qua</button>
                    <button class="btn btn-sm btn-info" onclick="acceptRecommendation('${rec.id}')">Chấp nhận</button>
                </div>
            </div>
        `;
        aiWidgetContainer.innerHTML = cardHTML;
    }

    async function acceptRecommendation(recId) {
        await fetch(`/api/ai-agent/recommendations/${recId}/act`, { method: 'POST' });
        const card = document.getElementById(`rec-${recId}`);
        if(card) card.remove();
        console.log(`Đã chấp nhận khuyến nghị: ${recId}`);
    }

    async function dismissRecommendation(recId) {
        await fetch(`/api/ai-agent/recommendations/${recId}/dismiss`, { method: 'POST' });
        const card = document.getElementById(`rec-${recId}`);
        if(card) card.remove();
        console.log(`Đã bỏ qua khuyến nghị: ${recId}`);
    }

    setInterval(fetchAiRecommendations, 10000);
    fetchAiRecommendations();

    // --- KHU VỰC CODE BIỂU ĐỒ & WEBSOCKET ---
    const forecastChartOptions = {
        series: [{ name: 'Lịch sử', data: [] }, { name: 'Dự báo', data: [] }],
        chart: {
            type: 'line',
            height: 300,
            background: 'transparent',
            toolbar: {
                show: true,
                tools: {
                    download: false,
                    selection: true,
                    zoom: true,
                    zoomin: true,
                    zoomout: true,
                    pan: true,
                    reset: true
                }
            },
            zoom: {
                enabled: true,
                type: 'x'
            }
        },
        theme: { mode: 'dark' },
        stroke: { width: [3, 3], curve: 'smooth', dashArray: [0, 5] },
        markers: { size: 0, hover: { size: 5 } },
        xaxis: { type: 'datetime', labels: { style: { colors: '#888' } } },
        yaxis: { labels: { style: { colors: '#888' } } },
        legend: {
            show: true,
            position: 'top',
            horizontalAlign: 'left'
        },
        tooltip: { theme: 'dark' }
    };
    const forecastChart = new ApexCharts(document.querySelector("#forecast-chart"), forecastChartOptions);
    forecastChart.render();

    const scheduleChartOptions = {
        series: [{ data: [] }],
        chart: { type: 'rangeBar', height: 300, background: 'transparent', toolbar: { show: false } },
        theme: { mode: 'dark' },
        plotOptions: { bar: { horizontal: true, distributed: true, dataLabels: { hideOverflowingLabels: false } } },
        dataLabels: { enabled: true, formatter: (val, opts) => opts.w.config.series[0].data[opts.dataPointIndex].name, style: { colors: ['#f3f4f5', '#fff'] } },
        xaxis: { type: 'datetime', labels: { style: { colors: '#888' } } },
        yaxis: { show: false },
        grid: { row: { colors: ['transparent', 'transparent'], opacity: 0.5 } },
        tooltip: { enabled: false }
    };
    const scheduleChart = new ApexCharts(document.querySelector("#schedule-chart"), scheduleChartOptions);
    scheduleChart.render();

    const ws = new WebSocket(`ws://${window.location.host}/ws/dashboard`);
    ws.onmessage = function(event) {
        const data = JSON.parse(event.data);
        
        let minX, maxX;
        if (forecastChart.w.globals.zoomed) {
            minX = forecastChart.w.globals.minX;
            maxX = forecastChart.w.globals.maxX;
        }

        const avg_temp = data.avg_temp;
        document.getElementById('avg_temp').innerHTML = `${avg_temp.toFixed(1)}<span class="fs-5 text-muted">°C</span>`;
        document.getElementById('humidity').innerHTML = `${data.humidity.toFixed(1)}<span class="fs-5 text-muted">%</span>`;
        document.getElementById('compressor_power_kw').textContent = data.compressor_power_kw.toFixed(1) + ' kW';
        updateStatus('compressor_status', data.compressor_status, 'ON', 'OFF');

        updateHeatmap(data.heatmap_data);

        forecastChart.updateSeries([ { name: 'Lịch sử', data: data.load_history }, { name: 'Dự báo', data: data.load_forecast } ]);
        
        const scheduleSeries = data.compressor_schedule.map(item => ({
            x: item.name,
            y: [item.start, item.end],
            fillColor: item.color,
            name: item.name
        }));
        scheduleChart.updateSeries([{ data: scheduleSeries }]);

        if (minX && maxX) {
            forecastChart.zoomX(minX, maxX);
        }
    };
    
    function updateHeatmap(data) {
        const container = document.getElementById('heatmap-container');
        container.innerHTML = '';
        const minTemp = -21, maxTemp = -18;

        data.forEach(rowData => {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'd-flex';
            rowData.forEach(temp => {
                const cellDiv = document.createElement('div');
                cellDiv.className = 'flex-grow-1 p-3 m-1 rounded';
                cellDiv.style.backgroundColor = getTempColor(temp, minTemp, maxTemp);
                rowDiv.appendChild(cellDiv);
            });
            container.appendChild(rowDiv);
        });
    }

    function getTempColor(temp, min, max) {
        const ratio = Math.max(0, Math.min(1, (temp - min) / (max - min)));
        const red = Math.round(255 * ratio);
        const blue = Math.round(255 * (1 - ratio));
        return `rgb(${red}, 80, ${blue})`;
    }
    
    function updateStatus(elementId, value, warnValue, goodValue) {
        const el = document.getElementById(elementId);
        el.textContent = value;
        el.className = 'badge ';
        if (value === 'ON') {
            el.classList.add('bg-danger');
        } else if (value === 'OFF') {
            el.classList.add('bg-success');
        }
    }
</script>
{% endblock %}