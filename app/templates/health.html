{% extends "base.html" %}

{% block title %}Sức khỏe Thiết bị{% endblock %}

{% block content %}
<h1 class="h2 mb-4">Giám sát Sức khỏe & Bảo trì Dự báo</h1>

<div class.card bg-dark-subtle border-secondary mb-4>
    <div class="card-header bg-warning-subtle text-warning-emphasis">
       <i class="bi bi-exclamation-triangle-fill me-2"></i>Thiết bị Cần Chú ý (Điểm sức khỏe < 80%)
    </div>
    <ul class="list-group list-group-flush" id="at-risk-list">
        </ul>
</div>


<div class="card bg-dark-subtle border-secondary">
    <div class="card-header">
        Tổng quan Tình trạng Thiết bị
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-dark table-hover mb-0">
                <thead>
                    <tr>
                        <th scope="col">Tên thiết bị</th>
                        <th scope="col">Loại</th>
                        <th scope="col">Trạng thái</th>
                        <th scope="col">Điểm Sức khỏe (%)</th>
                        <th scope="col">Dự báo Sự cố</th>
                        <th scope="col">Hành động Đề xuất</th>
                    </tr>
                </thead>
                <tbody id="health-table-body"></tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="device-details-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-device-name">Chi tiết Thiết bị</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-lg-7">
                        <div class="card bg-dark-subtle border-secondary mb-4">
                            <div class="card-header"><i class="bi bi-robot me-2"></i>Phân tích Bảo trì Dự báo từ AI</div>
                            <div class="card-body">
                                <p id="modal-ai-analysis"></p>
                            </div>
                        </div>
                        <div class="card bg-dark-subtle border-secondary">
                             <div class="card-header" id="modal-chart-title">Lịch sử các chỉ số vận hành (30 ngày qua)</div>
                            <div class="card-body">
                                <div id="modal-detail-chart"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-5">
                        <div class="card bg-dark-subtle border-secondary">
                            <div class="card-header"><i class="bi bi-journal-text me-2"></i>Nhật ký Bảo trì</div>
                            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                                <ul class="list-group list-group-flush" id="modal-maintenance-log">
                                    </ul>
                            </div>
                            <div class="card-footer">
                                <form id="add-log-form">
                                    <div class="input-group">
                                        <textarea id="log-input" class="form-control form-control-sm bg-dark text-white" rows="2" placeholder="Thêm ghi chú bảo trì..."></textarea>
                                        <button class="btn btn-sm btn-outline-info" type="submit">Lưu</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    let equipmentData = [];
    const deviceModal = new bootstrap.Modal(document.getElementById('device-details-modal'));
    let detailChart;

    function getHealthColor(score) {
        if (score > 80) return 'text-success';
        if (score > 60) return 'text-warning';
        return 'text-danger';
    }

    // HÀM MỚI: Render thẻ tóm tắt
    function renderAtRiskCard(data) {
        const atRiskList = document.getElementById('at-risk-list');
        atRiskList.innerHTML = '';
        const atRiskDevices = data.filter(d => d.health_score < 80);

        if (atRiskDevices.length === 0) {
            const item = document.createElement('li');
            item.className = 'list-group-item bg-dark-subtle text-muted';
            item.textContent = 'Không có thiết bị nào cần chú ý đặc biệt.';
            atRiskList.appendChild(item);
            return;
        }

        atRiskDevices.sort((a,b) => a.health_score - b.health_score).forEach(device => {
            const item = document.createElement('li');
            item.className = 'list-group-item bg-dark-subtle d-flex justify-content-between align-items-center';
            const healthScore = parseFloat(device.health_score).toFixed(1);
            item.innerHTML = `
                <div>
                    <strong class="${getHealthColor(healthScore)}">${device.name}</strong>
                    <small class="d-block text-muted">${device.recommendation}</small>
                </div>
                <span class="badge bg-danger rounded-pill">${healthScore}%</span>
            `;
            atRiskList.appendChild(item);
        });
    }

    // HÀM MỚI: Render bảng tổng quan
    function renderHealthTable(data) {
        const healthTableBody = document.getElementById('health-table-body');
        healthTableBody.innerHTML = '';
        data.forEach(device => {
            const row = document.createElement('tr');
            row.style.cursor = 'pointer';
            row.dataset.deviceId = device.id;
            const healthScore = parseFloat(device.health_score).toFixed(1);
            row.innerHTML = `
                <td>${device.name}</td>
                <td>${device.type}</td>
                <td><span class="badge bg-${device.status === 'Hoạt động' ? 'success' : 'secondary'}">${device.status}</span></td>
                <td><strong class="${getHealthColor(healthScore)}">${healthScore}%</strong></td>
                <td>${device.next_failure_forecast}</td>
                <td>${device.recommendation}</td>
            `;
            healthTableBody.appendChild(row);
        });
    }

    // HÀM CHÍNH: Lấy dữ liệu và gọi các hàm render
    async function initializePage() {
        try {
            const response = await fetch('/api/equipment-health');
            equipmentData = await response.json();
            
            renderAtRiskCard(equipmentData);
            renderHealthTable(equipmentData);

        } catch (error) {
            console.error('Failed to fetch equipment health data:', error);
        }
    }

    // Xử lý sự kiện click vào bảng để mở modal
    document.getElementById('health-table-body').addEventListener('click', (event) => {
        const row = event.target.closest('tr');
        if (!row) return;

        const deviceId = row.dataset.deviceId;
        const device = equipmentData.find(d => d.id === deviceId);
        if (!device) return;

        // Populate modal with basic data
        document.getElementById('modal-device-name').textContent = `Chi tiết: ${device.name}`;
        document.getElementById('modal-ai-analysis').textContent = device.ai_analysis;
        
        // NÂNG CẤP: Render biểu đồ đa chỉ số
        const series = Object.keys(device.history).map(key => ({
            name: key,
            data: device.history[key]
        }));

        const chartOptions = {
            series: series, chart: { type: 'line', height: 300, background: 'transparent', toolbar: { show: true, tools: { download: false } }, zoom: { enabled: true } }, theme: { mode: 'dark' }, stroke: { curve: 'smooth', width: 2 }, xaxis: { type: 'datetime', labels: { style: { colors: '#888' } } }, yaxis: series.map(s => ({ seriesName: s.name, title: { text: s.name, style: { color: '#888' } }, labels: { style: { colors: '#888' } } })), tooltip: { theme: 'dark', x: { format: 'dd/MM/yyyy' } }, legend: { position: 'top' },
        };
        
        if (detailChart) {
            detailChart.updateOptions(chartOptions);
        } else {
            detailChart = new ApexCharts(document.querySelector("#modal-detail-chart"), chartOptions);
            detailChart.render();
        }

        // NÂNG CẤP: Render nhật ký bảo trì và xử lý form
        const logList = document.getElementById('modal-maintenance-log');
        logList.innerHTML = '';
        device.maintenance_log.forEach(log => {
            const item = document.createElement('li');
            item.className = 'list-group-item bg-dark-subtle';
            item.textContent = log;
            logList.appendChild(item);
        });

        const logForm = document.getElementById('add-log-form');
        logForm.onsubmit = (e) => {
            e.preventDefault();
            const logInput = document.getElementById('log-input');
            const newLogText = logInput.value.trim();
            if (newLogText) {
                const newItem = document.createElement('li');
                newItem.className = 'list-group-item bg-dark-subtle';
                const today = new Date().toLocaleDateString('vi-VN');
                newItem.textContent = `${today}: ${newLogText}`;
                logList.prepend(newItem); // Thêm vào đầu danh sách
                logInput.value = '';
            }
        };

        deviceModal.show();
    });

    initializePage();
});
</script>
{% endblock %}